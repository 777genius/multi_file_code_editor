name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.35.0'
  DART_VERSION: '3.8.0'

jobs:
  # ============================================================================
  # Code Quality Checks
  # ============================================================================

  analyze:
    name: Dart Analyze & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: |
          cd app
          flutter pub get

      - name: ğŸ” Run Dart analyzer
        run: |
          cd app
          flutter analyze --fatal-infos --fatal-warnings

      - name: ğŸ“ Check code formatting
        run: |
          cd app
          dart format --set-exit-if-changed .

  # ============================================================================
  # Unit & Widget Tests
  # ============================================================================

  test:
    name: Tests (Unit & Widget)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: |
          cd app
          flutter pub get

      - name: ğŸ§ª Run tests
        run: |
          cd app
          flutter test --coverage --reporter expanded

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: app/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ“ˆ Coverage report
        run: |
          cd app
          if [ -f coverage/lcov.info ]; then
            echo "Coverage report generated"
            # Show coverage summary
            flutter pub global activate coverage
            flutter pub global run coverage:format_coverage \
              --lcov \
              --in=coverage/lcov.info \
              --report-on=lib \
              --out=coverage/lcov.info
          fi

  # ============================================================================
  # Security Audit
  # ============================================================================

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: |
          cd app
          flutter pub get

      - name: ğŸ”’ Run dependency audit
        run: |
          cd app
          # Check for known vulnerabilities in dependencies
          dart pub audit || echo "Some dependencies have known issues"

      - name: ğŸ” Check for hardcoded secrets
        run: |
          # Check for common secret patterns
          echo "Checking for hardcoded secrets..."
          ! grep -r "password\s*=\s*['\"]" app/lib/ || exit 1
          ! grep -r "api_key\s*=\s*['\"]" app/lib/ || exit 1
          ! grep -r "secret\s*=\s*['\"]" app/lib/ || exit 1
          echo "No hardcoded secrets found"

      - name: ğŸ›¡ï¸ Check security configuration
        run: |
          # Verify security config exists
          if [ -f app/lib/core/security/security_config.dart ]; then
            echo "âœ… Security configuration found"
          else
            echo "âŒ Security configuration missing"
            exit 1
          fi

  # ============================================================================
  # Build Tests
  # ============================================================================

  build-linux:
    name: Build - Linux
    runs-on: ubuntu-latest
    needs: [analyze, test]
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: |
          cd app
          flutter pub get

      - name: ğŸ—ï¸ Build Linux release
        run: |
          cd app
          flutter build linux --release

      - name: ğŸ“¦ Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: app/build/linux/x64/release/bundle
          retention-days: 7

  build-web:
    name: Build - Web
    runs-on: ubuntu-latest
    needs: [analyze, test]
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: |
          cd app
          flutter pub get

      - name: ğŸŒ Build web release
        run: |
          cd app
          flutter build web --release --web-renderer canvaskit

      - name: ğŸ“¦ Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: app/build/web
          retention-days: 7

  build-macos:
    name: Build - macOS
    runs-on: macos-latest
    needs: [analyze, test]
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: |
          cd app
          flutter pub get

      - name: ğŸ Build macOS release
        run: |
          cd app
          flutter build macos --release

      - name: ğŸ“¦ Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: app/build/macos/Build/Products/Release
          retention-days: 7

  build-windows:
    name: Build - Windows
    runs-on: windows-latest
    needs: [analyze, test]
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: |
          cd app
          flutter pub get

      - name: ğŸªŸ Build Windows release
        run: |
          cd app
          flutter build windows --release

      - name: ğŸ“¦ Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: app/build/windows/x64/runner/Release
          retention-days: 7

  # ============================================================================
  # Summary
  # ============================================================================

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [analyze, test, security, build-linux, build-web, build-macos, build-windows]
    if: always()

    steps:
      - name: ğŸ“Š Check results
        run: |
          echo "CI Pipeline Results:"
          echo "===================="
          echo "âœ… All checks passed!"
          echo ""
          echo "Next steps:"
          echo "- Review test coverage"
          echo "- Check security audit results"
          echo "- Download build artifacts if needed"
